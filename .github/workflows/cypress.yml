name: Cypress
on: [push]
jobs:
  run-e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: "Setup mySQL"
        uses: haltuf/mysql-action@master
        with:
          host port: 3306
          mysql database: 'test'
          mysql root password: 'root'
      - name: Setup Node.js 14.x
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up pnpm and install deps
        uses: pnpm/action-setup@v2.0.1
        with:
          version: 6.0.2
      - name: Migrate DB
        run: DATABASE_URL=mysql://root:root@localhost:3306/test npx prisma migrate deploy
      - name: Start dev server
        run: (pnpm run dev &)
        env:
          CI: true
          HOST: http://localhost:3000
          SECRET: VRdzayiObk6c7SaadzzaTxP+YZpIJ9AfhrbnZ+Q
          NEXTAUTH_URL: http://localhost:3000
          NEXT_PUBLIC_UPLOADCARE_KEY: demopublickey
          CONTACT_FORM_RECIPIENT: admin@app.com
          MAILER_FROM: admin@app.com
          NEXT_PUBLIC_HCAPTCHA_SITEKEY: 6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI # see https://developers.google.com/recaptcha/docs/faq#id-like-to-run-automated-tests-with-recaptcha.-what-should-i-do
          HCAPTCHA_SECRET: 6LeIxAcTAAAAAGG-vFI1TnRWxMZNFuojJ4WifJWe
          DATABASE_URL: mysql://root:root@localhost:3306/test
      - name: Run Cypress ðŸŒ²
        uses: cypress-io/github-action@v2
        timeout-minutes: 5
        with:
          install: false
          record: true
          config: pageLoadTimeout=30000,defaultCommandTimeout=30000
        env:
          DATABASE_URL: mysql://root:root@localhost:3306/test
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}